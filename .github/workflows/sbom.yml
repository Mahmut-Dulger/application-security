# SBOM generation workflow
# - Uses Anchore Syft action to generate CycloneDX SBOMs
# - Runs for `back-end`, `front-end`, and repository root
# - Uploads each SBOM as an artifact (visible on the Actions run page)

name: Generate SBOMs

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # weekly

permissions:
  contents: read

jobs:
  generate-sbom:
    name: Generate SBOMs (Syft)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: backend
            path: back-end
          - name: frontend
            path: front-end
          - name: repository-root
            path: .

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate SBOM for ${{ matrix.name }}
        uses: anchore/syft-action@v1
        with:
          # path to the project to inspect
          path: ${{ matrix.path }}
          # CycloneDX JSON is a broadly supported SBOM format
          format: cyclonedx-json
          # name of the generated output file (placed in workspace root)
          output: sbom-${{ matrix.name }}.cyclonedx.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ matrix.name }}
          path: sbom-${{ matrix.name }}.cyclonedx.json
          retention-days: 7

  scan-vulnerabilities:
    name: Scan SBOMs for Vulnerabilities (Grype)
    runs-on: ubuntu-latest
    needs: generate-sbom
    if: always()  # Run even if SBOM generation has warnings
    
    steps:
      - name: Download SBOM artifacts
        uses: actions/download-artifact@v4
        with:
          path: sboms/
          pattern: sbom-*

      - name: Run Grype vulnerability scan
        uses: anchore/grype-action@v1
        with:
          path: sboms/
          output-format: table
          fail-on: high  # Fail workflow on high or critical vulnerabilities
          
      - name: Upload Grype scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: grype-scan-results
          path: grype-results.*
          retention-days: 30

  npm-audit:
    name: npm audit for Direct Dependencies
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        path:
          - back-end
          - front-end
      fail-fast: false
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: '${{ matrix.path }}/package-lock.json'

      - name: Install dependencies
        run: npm ci
        working-directory: ${{ matrix.path }}

      - name: Run npm audit
        continue-on-error: true
        run: npm audit --json > npm-audit-${{ matrix.path }}.json 2>&1
        working-directory: ${{ matrix.path }}

      - name: Upload npm audit results
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-${{ matrix.path }}
          path: ${{ matrix.path }}/npm-audit-*.json
          retention-days: 30

# Notes:
# - Syft generates SBOMs; Grype scans them for known vulnerabilities
# - npm audit checks for vulnerable packages in package-lock.json
# - Set fail-on threshold based on your risk tolerance (info, low, medium, high, critical)
# - SBOMs are uploaded as artifacts for external analysis if needed
# - Audit reports are retained for 30 days for trend analysis
