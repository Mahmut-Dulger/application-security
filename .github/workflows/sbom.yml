# SBOM generation & dependency audit workflow
# - Generates SBOMs locally (pre-committed to repo)
# - Audits dependencies for known vulnerabilities
# - Runs on: push, PR, weekly schedule, manual trigger

name: Generate SBOMs & Audit Dependencies

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # weekly

permissions:
  contents: read

jobs:
  npm-audit:
    name: npm audit for Dependencies
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        path:
          - back-end
          - front-end
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: '${{ matrix.path }}/package-lock.json'

      - name: Install dependencies
        run: npm ci
        working-directory: ${{ matrix.path }}

      - name: Run npm audit
        continue-on-error: true
        run: npm audit --json > ../npm-audit-${{ matrix.path }}.json 2>&1
        working-directory: ${{ matrix.path }}

      - name: Display audit summary
        run: |
          echo "=== npm audit summary for ${{ matrix.path }} ==="
          cat ../npm-audit-${{ matrix.path }}.json | jq '.metadata.vulnerabilities' 2>/dev/null || echo "No metadata found"
        working-directory: ${{ matrix.path }}
        continue-on-error: true

      - name: Upload npm audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-audit-${{ matrix.path }}
          path: npm-audit-${{ matrix.path }}.json
          retention-days: 30

  generate-sbom:
    name: Generate SBOMs (Syft)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Syft
        run: curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Generate backend SBOM
        run: syft back-end -o cyclonedx-json > sbom-backend-ci.cyclonedx.json
        continue-on-error: true

      - name: Generate frontend SBOM
        run: syft front-end -o cyclonedx-json > sbom-frontend-ci.cyclonedx.json
        continue-on-error: true

      - name: Generate repository SBOM
        run: syft . -o cyclonedx-json > sbom-repository-ci.cyclonedx.json
        continue-on-error: true

      - name: Upload SBOMs as artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sbom-reports
          path: sbom-*.cyclonedx.json
          retention-days: 7

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [ npm-audit ]
    if: always()
    
    steps:
      - name: Download audit reports
        uses: actions/download-artifact@v4
        with:
          path: audit-results/
        continue-on-error: true

      - name: Generate summary
        run: |
          echo "## ðŸ” Dependency Vulnerability Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for file in audit-results/npm-audit-*/npm-audit-*.json; do
            if [ -f "$file" ]; then
              name=$(basename $(dirname "$file"))
              echo "### $name" >> $GITHUB_STEP_SUMMARY
              jq -r '.metadata.vulnerabilities // empty | to_entries | .[] | "- \(.key): \(.value)"' "$file" 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done
        continue-on-error: true

# Notes:
# - SBOMs are pre-generated locally and committed to repo for audit trail
# - This workflow validates in CI/CD and runs npm audit on each push/PR
# - Syft installed at runtime from official source
# - Artifacts: SBOMs (7 days), npm audit (30 days)
# - Manual: syft <path> -o cyclonedx-json > sbom.json
